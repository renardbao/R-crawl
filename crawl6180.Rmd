---
title: "爬主力進出"
author: "包孟晨"
date: "2017年9月30日"
output: 
 html_document:
   toc: true
   toc_depth: 2
   toc_float: true
---

```{r setup, include=FALSE}
library(xml2)
library(magrittr)
```
##找尋目標URL
最近因為天堂m的關係而關注了橘子6180，也就這樣產生了想看看每天各大券商進出這支股票的數量，順便
練習一下爬蟲。

觀察一下目標網頁的內容：

<img src="picture/1.png" width="80%" />

我沒辦法從網址上找到有規律的邏輯。因此，我要透過其他方法來觀察目標網頁，在這裡用的是Chrome  的開發人員工具，先在這一頁按下快捷鍵Cmd/Ctrl + Shift + i(或者是右上角三個點點  > 更多工具 > 開發人員工具)，切換到Network分頁，重新整理後便可以看到瀏覽過程的所有連線。

不過還是沒辦法取得我想要的資訊，這時候將連線清除(左上角禁止的圖案)，然後點選查詢來查詢最近一日
的主力進出!
<img src="picture/2.png" width="80%" />
所以我就找到啦!  
 $\rightarrow$ http://jdata.yuanta.com.tw/z/zc/zco/zco.djhtm?a=6180&e=2017-9-29&f=2017-9-29  
 網址上包含了股票代碼以及搜尋日期，也就是說我只需要更動這三個地方就能取得資料！！
 
##Double-Digtal日期格式
```{r}
#目標股票
stock <- as.character(6180)
#運用X來標記要消掉的
date <- as.Date(0:365,origin = "2017-7-30") %>% format("%Y-X%m-X%d") %>% 
            gsub("X0","",.) %>% gsub("X","",.) 
url <- paste0('http://jdata.yuanta.com.tw/z/zc/zco/zco.djhtm?a=',stock,'&e=',date,'&f=',date)
```
關於日期date的部分讓我頭痛了一陣子，因為我發現元大網站並不支援R內建時間格式2017-09-09這樣月跟日
是double-digtal，只能是2017-9-9這樣的形式，也就是我必須想辦法把0去掉。假如是單純的把0去掉，也會
把年分2017的0也去掉了，後來我爬了stackoverflow的文，發現[這篇文](https://stackoverflow.com/questions/31065993/how-to-deal-with-days-and-or-month-with-one-digit-remove-the-0-in-r)**RHertel**大所提供的方法挺有趣又好用的!

也就是我`date`裡面所用到的方法，他是透過用"X"來標記月跟日的前面，透過`gsub`將"X0"消掉前面有0的數字，然後再`gsub`一次將剩餘沒搭配到0的"X"給消掉，這樣就不會消到2017的0又能將月跟日的0給消掉了!

##目標資料
<img src="picture/3.png" width="80%" />


這就是我想要取下來的資料，對著其中一欄點右鍵$\rightarrow$檢查 會得到xpath


<img src="picture/4.png" width="80%" />

我會發現券商的名字那格都會叫做`td class='t4t1'`，而後面的資料都叫做`td class='t3n1'`
這些將有利我撰寫xpath，讓我可以順利從網頁上下載我想要的資料。

我使用的套件是`xml2`，主要是使用以下函數:
+ read_html()：將網址所對應的html頁面，儲存成一個物件。

+ xml_find_all()：找到符合「規則」的所有html原始碼。

+ xml_text()：從html原始碼中，取出內容。

+ xml_attr()：從html原始碼中，取出屬性。

```{r}
#券商的標籤
xpath1 <- '//*[@class="t4t1"]/a'
#券商資料的標籤
xpath2 <-'//*[@class="t3n1"]'
#extract node
target = xml_find_all(read_html(url(url[2])), xpath1)##2017-7-31
target2 <- xml_find_all(read_html(url(url[2])), xpath2)
#2017-7-31當日主力券商
broker = xml_text(target)
```


然後取得券商後面的資料

```{r}
#2017-7-31
rawdata <- xml_text(target2)
rawdata 
#去掉後面四個多餘的資料
rawdata <- rawdata[-c(121:124)]
rawdata

```


##整理資料
我們會發現每四筆資料為一組，並且依照順序為買進、賣出、買超和佔成交比重，賣超方則為買進、賣出、賣超及佔成交比重

```{r}
data1 <-matrix(rawdata,ncol=length(rawdata)/4,nrow=4) %>% t() 
data1 <- data.frame(broker,data1,date[2])
colnames(data1)[c(2:6)] <- c("買進","賣出","買賣超","佔成交比重","日期")
data1
```


我取得了2017-7-31日當天主力進出的各個券商，值得注意的是奇數是買超券商，偶數是賣超券商。所以分組過後$\downarrow$
```{r}
#奇數買超券商
netbuyer <- data1[(1:length(broker))%%2!=0,]
#偶數賣超券商
netseller <-data1[(1:length(broker))%%2==0,]
netbuyer;netseller
```


