---
title: "爬主力進出"
author: "包孟晨"
date: "2017年9月30日"
output: html_document
---

```{r setup, include=FALSE}
library(xml2)
library(magrittr)
```

最近因為天堂m的關係而關注了橘子6180，也因此產生了想看看每天各大券商進出這支股票的數量，順便
練習一下爬蟲。

觀察一下目標網頁的內容：

<img src="C:/Users/user/Documents/爬蟲學習/1.png" width="80%" />

我沒辦法從網址上找到有規律的邏輯。因此，我要透過其他方法來觀察目標網頁，在這裡用的是Chrome  的開發人員工具，先在這一頁按下快捷鍵Cmd/Ctrl + Shift + i(或者是右上角三個點點  > 更多工具 > 開發人員工具)，切換到Network分頁，重新整理後便可以看到瀏覽過程的所有連線。

不過還是沒辦法取得我想要的資訊，這時候將連線清除(左上角禁止的圖案)，然後點選查詢來查詢最近一日
的主力進出!


<img src="C:/Users/user/Documents/爬蟲學習/2.png" width="80%" />

所以我就找到啦!  
 $\rightarrow$ http://jdata.yuanta.com.tw/z/zc/zco/zco.djhtm?a=6180&e=2017-9-29&f=2017-9-29  
 網址上包含了股票代碼以及搜尋日期，也就是說我只需要更動這三個地方就能取得資料！！
 
```{r}
stock <- as.character(6180)  ###股票代碼
date <- as.Date(0:60,origin = "2017-7-30") %>% format("%Y-X%m-X%d") %>% 
            gsub("X0","",.) %>% gsub("X","",.)  ###日期
url <- paste0('http://jdata.yuanta.com.tw/z/zc/zco/zco.djhtm?a=',stock,'&e=',date,'&f=',date)
head(url)      
```
關於日期date的部分讓我頭痛了一陣子，因為我發現元大網站並不支援R內建時間格式2017-09-09這樣月跟日
是double-digtal，只能是2017-9-9這樣的形式，也就是我必須想辦法把0去掉。假如是單純的把0去掉，也會
把年分2017的0也去掉了，後來我爬了stackoverflow的文，發現[這篇文](https://stackoverflow.com/questions/31065993/how-to-deal-with-days-and-or-month-with-one-digit-remove-the-0-in-r)**RHertel**大所提供的方法挺有趣又好用的!

也就是我`date`裡面所用到的方法，他是透過用"X"來標記月跟日的前面，透過`gsub`將"X0"消掉前面有0的數字，然後再`gsub`一次將剩餘沒搭配到0的"X"給消掉，這樣就不會消到2017的0又能將月跟日的0給消掉了!


<img src="C:/Users/user/Documents/爬蟲學習/3.png" width="80%" />


這就是我想要取下來的資料，對著其中一欄點右鍵$\rightarrow$檢查會得到下圖的東東


<img src="C:/Users/user/Documents/爬蟲學習/4.png" width="80%" />

我會發現券商的名字那格都會叫做`td class='t4t1'`，而後面的資料都叫做`td class='t3n1'`
這些將有利我撰寫xpath，讓我可以順利從網頁上下載我想要的資料。

我使用的套件是`xml2`，主要是使用以下函數:
+ read_html()：將網址所對應的html頁面，儲存成一個物件。

+ xml_find_all()：找到符合「規則」的所有html原始碼。

+ xml_text()：從html原始碼中，取出內容。

+ xml_attr()：從html原始碼中，取出屬性。

```{r}
xpath1 <- '//*[@class="t4t1"]/a'
target = xml_find_all(read_html(url(url[2])), xpath1) ##2017-7-31
broker = xml_text(target)
broker
```


然後取得券商後面的資料

```{r}
xpath2 <-'//*[@class="t3n1"]'
target2 <- xml_find_all(read_html(url(url[2])), xpath2)
rawdata <- xml_text(target2)
rawdata 
rawdata <- rawdata[-c(121:124)]
rawdata

```


我會發現每四筆資料為一組，並且依照順序為買進、賣出、買超和佔成交比重，賣超方則為買進、賣出、賣超及佔成交比重

```{r}
data1 <-matrix(rawdata,ncol=length(rawdata)/4,nrow=4) %>% t() 
data1 <- data.frame(broker,data1)
colnames(data1)[c(2:5)] <- c("買進","賣出","買賣超","佔成交比重")
data1
```











我取得了2017-7-31日當天主力進出的各個券商，值得注意的是奇數是買超券商，偶數是賣超券商。所以我得先
分組$\downarrow$
```{r}
netbuyer <- broker[(1:length(broker))%%2!=0]
netseller <- broker[(1:length(broker))%%2==0]
netbuyer;netseller
```


